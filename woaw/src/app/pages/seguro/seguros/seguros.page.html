<app-navbar></app-navbar>

<ion-content [fullscreen]="true">
  <app-spinner *ngIf="mostrar_spinnet"></app-spinner>
  <div class="fondo-diagonal"></div>

  <div class="progress">
    <div class="progress__bar" [style.width.%]="progress()"></div>
    <div class="progress__markers">
      <span *ngFor="let step of steps; let i = index" [style.left.%]="(100 / (steps.length - 1)) * i"
        [class.done]="i + 1 < currentStep" [class.active]="i + 1 === currentStep">
        {{ step }}
      </span>
    </div>
  </div>

  <div class="layout-seguros" *ngIf="!cotizacion">
    <div class="cotiza">
      <section class="cotiza__card">

        <header class="cotiza__head">
          <span class="badge">Seguro de auto · Woaw</span>
          <h1>Cotiza tu seguro de auto</h1>
          <p>En segundos</p>
        </header>

        <form [formGroup]="form">

          <div class="field" *ngIf="currentStep === 1">
            <label for="marca">Selecciona una marca</label>
            <div class="control control--select">
              <ion-select formControlName="marca" interface="popover" placeholder="Elige una marca..."
                aria-label="Marca">
                <ion-select-option [value]="null" disabled>Elige una marca...</ion-select-option>
                <ion-select-option *ngFor="let m of marcas" [value]="m.id">
                  {{ m.name | titlecase }}
                </ion-select-option>
              </ion-select>
            </div>
          </div>

          <div class="field" *ngIf="currentStep === 2">
            <label for="modelo">Selecciona el modelo</label>
            <div class="control control--select">
              <ion-select formControlName="modelo" interface="popover" placeholder="Elige un modelo..."
                aria-label="Modelo">
                <ion-select-option [value]="null" disabled>Elige un modelo...</ion-select-option>
                <ion-select-option *ngFor="let mo of modelos" [value]="mo.id">
                  {{ mo.name | titlecase }}
                </ion-select-option>
              </ion-select>
            </div>
          </div>

          <div class="field" *ngIf="currentStep === 3">
            <label for="año">Selecciona el año</label>
            <div class="control control--select">
              <ion-select formControlName="anio" interface="popover" placeholder="Elige un año..." aria-label="Año">
                <ion-select-option [value]="null" disabled>Elige un año...</ion-select-option>
                <ion-select-option *ngFor="let y of anios" [value]="y">
                  {{ y }}
                </ion-select-option>
              </ion-select>
            </div>
          </div>

          <div class="field" *ngIf="currentStep === 4">
            <label for="version">Selecciona la versión</label>
            <div class="control control--select">
              <ion-select formControlName="version" interface="popover" placeholder="Elige una versión..."
                aria-label="Versión">
                <ion-select-option [value]="null" disabled>Elige una versión...</ion-select-option>
                <ion-select-option *ngFor="let v of versions" [value]="v.id">
                  {{ v.parts | titlecase }}
                </ion-select-option>
              </ion-select>
            </div>
          </div>

          <div class="field" *ngIf="currentStep === 5">
            <label>Fecha de nacimiento</label>

            <div class="fecha-flex">
              <div class="control control--select">
                <ion-select formControlName="nacDia" interface="popover" placeholder="Día" aria-label="Día">
                  <ion-select-option [value]="null" disabled>Día</ion-select-option>
                  <ion-select-option *ngFor="let d of dias" [value]="d">
                    {{ d }}
                  </ion-select-option>
                </ion-select>
                <!-- <button type="button" class="icon-btn" aria-label="Regresar" (click)="clearFecha()">&#x2B05;</button> -->
              </div>

              <div class="control control--select">
                <ion-select formControlName="nacMes" interface="popover" placeholder="Mes" aria-label="Mes">
                  <ion-select-option [value]="null" disabled>Mes</ion-select-option>
                  <ion-select-option *ngFor="let m of meses" [value]="m.v">
                    {{ m.l }}
                  </ion-select-option>
                </ion-select>
              </div>

              <div class="control control--select">
                <ion-select formControlName="nacAnio" interface="popover" placeholder="Año" aria-label="Año">
                  <ion-select-option [value]="null" disabled>Año</ion-select-option>
                  <ion-select-option *ngFor="let y of aniosNacimiento" [value]="y">
                    {{ y }}
                  </ion-select-option>
                </ion-select>
              </div>
            </div>
          </div>

          <div class="field" *ngIf="currentStep === 6">

            <label for="cp">Código Postal</label>
            <div class="control">
              <input id="cp" type="text" class="form-input" maxlength="5" placeholder="Ej. 76000"
                formControlName="cp" />
            </div>

            <!-- Género -->
            <label for="genero" style="margin-top:12px;">Género</label>
            <div class="control control--select">
              <ion-select formControlName="genero" interface="popover" placeholder="Selecciona..." aria-label="Género">
                <ion-select-option [value]="null" disabled>Selecciona...</ion-select-option>
                <ion-select-option *ngFor="let g of generoOpts" [value]="g.value">
                  {{ g.label }}
                </ion-select-option>
              </ion-select>
            </div>

            <label for="estadoCivil" style="margin-top:12px;">Estado civil</label>
            <div class="control control--select">
              <ion-select formControlName="estadoCivil" interface="popover" placeholder="Selecciona..."
                aria-label="Estado civil">
                <ion-select-option [value]="null" disabled>Selecciona...</ion-select-option>
                <ion-select-option *ngFor="let e of estadoCivilOpts" [value]="e.value">
                  {{ e.label }}
                </ion-select-option>
              </ion-select>
              <!-- <button type="button" class="icon-btn" aria-label="Regresar" (click)="clearPaso6()">&#x2B05;</button> -->
            </div>

          </div>

          <!-- Paso 8: Resumen -->
          <div class="field" *ngIf="currentStep === 7">
            <label>Verifica tu información</label>

            <div class="summary">
              <div class="summary__row">
                <span class="k">Marca</span><span class="v">{{ getMarcaLabel() }}</span>
              </div>
              <div class="summary__row">
                <span class="k">Modelo</span><span class="v">{{ getModeloLabel() }}</span>
              </div>
              <div class="summary__row">
                <span class="k">Año</span><span class="v">{{ form.get('anio')?.value }}</span>
              </div>
              <div class="summary__row">
                <span class="k">Versión</span><span class="v">{{ getVersionLabel() }}</span>
              </div>
              <div class="summary__row">
                <span class="k">Nacimiento</span><span class="v">{{ getNacimiento() }}</span>
              </div>
              <div class="summary__row">
                <span class="k">C.P.</span><span class="v">{{ form.get('cp')?.value }}</span>
              </div>
              <div class="summary__row">
                <span class="k">Género</span><span class="v">{{ getGeneroLabel() }}</span>
              </div>
              <div class="summary__row">
                <span class="k">Estado civil</span><span class="v">{{ getEstadoCivilLabel() }}</span>
              </div>
              <!-- <div class="summary__row">
              <span class="k">Duración</span><span class="v">{{ form.get('duracion')?.value }} meses</span>
            </div> -->
            </div>

            <!-- <button type="button" class="icon-btn" aria-label="Regresar" (click)="clearPaso8()">&#x2B05;</button> -->

          </div>

          <div class="paybox__cta">
            <button type="button" *ngIf="currentStep !== 1" class="btn-secondary"
              (click)="ClearRegrasar()">&#x2B05;</button>
            <button class="btn-primary" type="button" (click)="siguiente()" [disabled]="
              (currentStep===1 && form.get('marca')?.invalid) ||
              (currentStep===2 && form.get('modelo')?.invalid) ||
              (currentStep===3 && form.get('anio')?.invalid)   ||
              (currentStep===4 && form.get('version')?.invalid)||
              (currentStep===5 && form.get('nacDia')?.invalid || form.get('nacMes')?.invalid || form.get('nacAnio')?.invalid)                 ||
              (currentStep===6 && (form.get('cp')?.invalid || form.get('genero')?.invalid || form.get('estadoCivil')?.invalid))
            ">
              {{ currentStep < 7 ? 'Siguiente ' : 'Cotizar' }} </button>
          </div>

        </form>
      </section>

    </div>

    <div class="carta_pre_cotizacion">
      <div class="contenido_pre_cotizacion">
        <!-- <img src="/assets/icon/logo3.png" alt="Logo woaw" class="logo_original grande" loading="lazy" /> -->
        <!-- <img src="/assets/icon/logo2.png" alt="Logo woaw" class="logo_original pequeno" loading="lazy" /> -->
        <div class=container_animacion>
          Make
          <div id=flip>
            <div>
              <div>wOrK</div>
            </div>
            <div>
              <div>lifeStyle</div>
            </div>
            <div>
              <div>Everything</div>
            </div>
          </div>
          AweSoMe!
        </div>
      </div>
    </div>

  </div>

  <!-- resultado de la cotización  -->

  <div class="layout-seguros" *ngIf="cotizacion">

    <div class="cotizacion_carta">
      <section class="cotizacion_carta__card">
        <ng-container *ngIf="quote as q">
          <h2>Resultado de tu cotización</h2>

          <div class="quote-head">

            <div class="quote-summary">
              <div class="qs__row">
                <span class="k">Vehículo</span>
                <span class="v">
                  {{ q.vehicle?.brand?.name | titlecase }}
                  {{ q.vehicle?.model?.name | titlecase }}
                  {{ q.vehicle?.year?.name }} ·
                  {{ q.vehicle?.version?.name | titlecase }}
                </span>
              </div>

              <div class="qs__row">
                <span class="k">Ubicación</span>
                <span class="v">CP {{ q.region?.postal_code }} · {{ q.region?.state?.name }}</span>
              </div>

              <div class="qs__row" *ngIf="q.duration">
                <span class="k">Duración</span>
                <span class="v">{{ q.duration }} meses</span>
              </div>

              <div class="qs__row" *ngIf="q.coupon">
                <span class="k">Cupón</span>
                <span class="v">{{ q.coupon }}</span>
              </div>
            </div>
          </div>

          <div class="planes" *ngIf="q.plans?.length">
            <section class="plan" *ngFor="let p of q.plans">
              <div class="paybox">

                <div class="">
                  <ion-select [(ngModel)]="selectedPaymentByPlan[p.id]" (ngModelChange)="onSelectPayment(p.id, $event)"
                    interface="popover" placeholder="Elige un plan de pago..." aria-label="Plan de pago"
                    class="pay-select">
                    <ion-select-option *ngFor="let opt of p.payment_plans; trackBy: trackByPayment" [value]="opt.id">
                      {{ paymentPlanLabel(opt) }} — {{ fmtMoney(opt.total) }}
                    </ion-select-option>
                  </ion-select>
                </div>

                <div class="paybox__pricecard" *ngIf="getSelectedPayment(p) as sel">
                  <ng-container *ngIf="paymentSummary(sel) as s">
                    <div class="pricecard__row" *ngIf="s.variable">
                      <span class="k">1er pago</span>
                      <span class="v">{{ fmtMoney(s.first) }}</span>
                    </div>
                    <div class="pricecard__row" *ngIf="s.variable && s.restCount > 0">
                      <span class="k">{{ s.restCount }} pagos de</span>
                      <span class="v">{{ fmtMoney(s.rest) }}</span>
                    </div>

                    <div class="pricecard__row" *ngIf="!s.variable && !s.isOneShot">
                      <span class="k">{{ s.count }} pagos de</span>
                      <span class="v">{{ fmtMoney(s.per) }}</span>
                    </div>

                    <div class="pricecard__row" *ngIf="s.isOneShot">
                      <span class="k">Pago único</span>
                      <span class="v">{{ fmtMoney(s.total) }}</span>
                    </div>

                    <div class="pricecard__divider"></div>
                    <div class="pricecard__row is-total">
                      <span class="k">Total a pagar</span>
                      <span class="v">{{ fmtMoney(s.total) }}</span>
                    </div>
                  </ng-container>
                </div>

                <!-- CTA -->
                <div class="paybox__cta">
                  <button type="button" class="btn-secondary" (click)="nuevoSeguro()">Cotizar nuevamente</button>
                  <button type="button" class="btn-primary" (click)="confirmarPoliza()">Continuar</button>
                </div>
              </div>
            </section>
          </div>

        </ng-container>
      </section>
    </div>

    <div class="carta_pre_cotizacion">
      <!-- <img src="/assets/icon/logo4.png" alt="Logo Go Autos" class="logo_original" loading="lazy" /> -->
      <div class="paybox-info" *ngIf="activePlan && getPlanCoverages(activePlan) as covs">
        <h4 class="paybox-info__title">Coberturas incluidas</h4>
        <ul class="benefits">
          <li class="benefit" *ngFor="let c of covs; trackBy: trackByCov">
            <span class="k">{{ c.label }}</span>
            <span class="v">
              <ng-container *ngIf="c.amountText; else included">{{ c.amountText }}</ng-container>
              <ng-template #included>Incluida</ng-template>
              <ng-container *ngIf="c.deductible != null"> · Deducible {{ (c.deductible * 100) | number:'1.0-0'
                }}%</ng-container>
            </span>
          </li>
        </ul>
      </div>
    </div>

  </div>

  <app-footer></app-footer>
</ion-content>