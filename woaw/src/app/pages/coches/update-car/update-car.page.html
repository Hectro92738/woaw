<ion-header>
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <div class="perfil-header">
        <button class="btn-regresar" (click)="regresar()">
          <ion-icon name="arrow-back-outline"></ion-icon>
        </button>

        <img src="/assets/icon/logo4.png" alt="Go Autos" class="logo" />
        <span *ngIf="auto" class="titulo-perfil">{{ auto.marca }} {{ auto.modelo }} {{ auto.anio }}</span>
      </div>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button (click)="regresar()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="contenedor">

    <!-- ##----- Versión y Precio Editables ----- -->
    <ion-grid *ngIf="auto?.version?.length && tipo_veiculo === 'autos'">
      <ion-row class="row-versiones">
        <ion-col *ngFor="let v of auto.version; let i = index" class="version-col" size="6" size-sm="6" size-md="4">

          <div class="contenedor-input-version">
            <label class="titulo-version">{{ v.Name }}</label>
            <ion-item lines="none">
              <ion-label position="floating">Precio</ion-label>
              <ion-input type="number" [(ngModel)]="auto.version[i].Precio" (ionInput)="verificarCambiosPrecio()">
              </ion-input>
              <ion-button *ngIf="auto.tipoVenta == 'nuevo'" fill="clear" color="danger" (click)="eliminarVersion(i)"
                slot="end">
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
            </ion-item>
          </div>

        </ion-col>
      </ion-row>
    </ion-grid>

    <div class="contenedor_ubicaciones">

      <div class="opciones-vehiculo">
        <!-- Particular -->
        <div class="casilla" [class.activa]="tipoSeleccionado === 'particular'" (click)="seleccionarTipo('particular')">
          <img src="assets/img/particular.png" alt="Particular" />
          <p>Particular</p>
          <ion-icon name="checkmark-circle-outline" class="icono-check"></ion-icon>
        </div>

        <!-- Lote -->
        <div class="casilla" [class.activa]="tipoSeleccionado === 'lote'"
          *ngIf="auto && (auto.tipoVenta === 'usado' || auto.tipoVenta === 'seminuevo') && (MyRole === 'admin' || MyRole === 'lotero')"
          (click)="seleccionarTipo('lote')">
          <img src="assets/img/lote.png" alt="Lote" />
          <p>Lote</p>
          <ion-icon name="checkmark-circle-outline" class="icono-check"></ion-icon>
        </div>
      </div>

      <div class="contenedor_version" *ngIf="tipoSeleccionado === 'lote' && (MyRole == 'admin' || MyRole == 'lotero')">
        <!-- Selección de lote -->
        <ion-item>
          <ion-label position="stacked">Lote</ion-label>
          <ion-select [(ngModel)]="loteSeleccionado" placeholder="Selecciona un lote"
            (ionChange)="seleccionarLote($event.detail.value)">
            <ion-select-option *ngFor="let lote of lotes" [value]="lote._id">
              {{ lote.nombre || 'Lote sin nombre' }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Selección de ubicación (si hay varias) -->
        <ion-item *ngIf="ubicacionesLoteSeleccionado.length > 1">
          <ion-label position="stacked">Ubicación</ion-label>
          <ion-select [(ngModel)]="direccionSeleccionada" placeholder="Selecciona una ubicación" (ionChange)="onUbicacionChange($event)">
            <ion-select-option *ngFor="let direccion of ubicacionesLoteSeleccionado; let i = index" [value]="direccion">
              {{ ubicacionesLoteLegibles[i] || 'Obteniendo dirección...' }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Input solo si hay una única ubicación (editable si quieres) -->
        <ion-item *ngIf="ubicacionesLoteSeleccionado.length === 1">
          <ion-input style="font-size: 10px;" readonly [value]="direccionSeleccionada?.calle || direccionSeleccionada?.ciudad">{{direccionCompleta}}</ion-input>
        </ion-item>
      </div>

      <div class="bloque-ubicacion"
        *ngIf="tipoSeleccionado === 'particular' && (MyRole == 'admin' || MyRole == 'vendedor' || MyRole == 'cliente')">
        <button class="btn_ubicacion" type="button" (click)="seleccionarUbicacion()">
          <ion-icon name="location-outline" class="icono"></ion-icon>
          Seleccionar ubicación
        </button>

        <div *ngIf="ubicacionSeleccionada" class="ubicacion-mostrada">
          <ion-icon name="location-outline"></ion-icon>
          {{ direccionCompleta }}
        </div>
      </div>
    </div>

    <!-- ##-----  -->
    <ion-grid>
      <ion-row>

        <!-- Columna izquierda -->
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Imagen principal del auto</ion-card-title>
              <ion-card-subtitle>Selecciona una imagen para remover el fondo</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <!-- 🔁 Botón de restablecer -->
              <div class="botons">
                <button class="button-nuevo" (click)="seleccionarImagen()">
                  <ion-icon name="add-outline"></ion-icon>
                  Nueva imagen
                </button>
                <input type="file" accept="image/*" hidden #inputArchivo (change)="cargarNuevaImagen($event)" />

              </div>

              <!-- Imagen grande -->
              <div class="contenedor-imagen">
                <img [src]="imagenPrincipalMostrada" alt="Imagen principal del auto" />
              </div>
              <p class="texto_css">Seleciona una imagen remover el fondo</p>
              <div class="galeria-scroll" *ngIf="urlsImagenes?.length">
                <img *ngFor="let img of urlsImagenes" [src]="img" alt="Imagen del auto"
                  (click)="actualizarImagenPrincipal(img)" />
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- Columna derecha (vacía por ahora) -->
        <ion-col size="12" size-md="6">

          <ion-card>
            <ion-card-header>
              <ion-card-title>Imagenes de mi auto</ion-card-title>
              <ion-card-subtitle>Agrega maximo 10 Imgaenes</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>

              <label class="btn-agregar">
                <ion-icon name="add-outline"></ion-icon>
                Agregar imagen
                <input type="file" accept="image/*" (change)="agregarImagen($event)" hidden />
              </label>


              <div class="galeria-scroll-big" *ngIf="urlsImagenes?.length">
                <div class="img-wrapper" *ngFor="let img of urlsImagenes">
                  <img [src]="img" alt="Imagen del auto" />
                  <div class="overlay-botones">
                    <button class="btn-accion eliminar" (click)="eliminarImagen_visual(img)">
                      <ion-icon name="trash-outline"></ion-icon>
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>

            </ion-card-content>
          </ion-card>

        </ion-col>
      </ion-row>
    </ion-grid>
    <!-- ##-----  -->
  </div>

  <app-footer></app-footer>

</ion-content>
<ion-footer>
  <ion-toolbar>
    <div class="botones-footer">

      <ion-button color="dark" *ngIf="!restablecer" expand="block" (click)="regresar()">
        <ion-icon name="close-outline"></ion-icon>
        Cancelar
      </ion-button>

      <ion-button color="warning" *ngIf="restablecer" expand="block" (click)="restablecerDatos()">
        <ion-icon name="refresh-outline"></ion-icon>
        Restablecer cambios
      </ion-button>

      <ion-button color="danger" expand="block" (click)="alert(auto._id)">
        <ion-icon name="trash-outline"></ion-icon>
        Eliminar auto
      </ion-button>

      <ion-button color="success" [disabled]="!restablecer" expand="block" (click)="alertPutCar(auto._id)">
        <ion-icon name="save-outline"></ion-icon>
        Guardar cambios
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>
