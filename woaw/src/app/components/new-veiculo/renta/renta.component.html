<section class="renta">
  <!-- Resumen/encabezado -->
  <div class="resumen">

    <!-- Botón publicar -->
    <button type="button" class="btn-publicar" (click)="publicar()">
      <ion-icon name="save-outline"></ion-icon>
      Publicar
    </button>

    <div class="fila">
      <p>Año: <strong>{{ anio }}</strong></p>
      <p>Marca: <strong>{{ marca }}</strong></p>
      <p>Modelo: <strong>{{ modelo }}</strong></p>
    </div>
  </div>

  <!-- Ubicación + Imágenes -->
  <div class="bloques">
    <div class="bloque">
      <!-- Botón ubicación -->
      <button type="button" class="btn btn-lg btn-green" (click)="seleccionarUbicacion()">
        <ion-icon name="location-outline"></ion-icon>
        Seleccionar ubicación
      </button>

      <div class="ubicacion" *ngIf="direccionCompleta">
        <ion-icon name="location-outline"></ion-icon>
        <span>{{ direccionCompleta }}</span>
      </div>
    </div>

    <div class="bloque">
      <div class="grupo-botones">
        <!-- Botón imágenes -->
        <button class="btn btn-lg btn-blue" type="button" (click)="seleccionarImagenes()">
          <ion-icon name="image-outline"></ion-icon>
          Seleccionar imágenes
        </button>

        <button *ngIf="imagenesIntentadas" class="btn btn-lg btn-danger btn-full" type="button"
          (click)="limpiarImagenes()">
          <ion-icon name="trash-outline"></ion-icon>
          Limpiar imágenes
        </button>
      </div>

      <label class="tc">
        <span class="tc__label">Tarjeta de circulación (opcional)</span>

        <!-- Botón consistente con los demás -->
        <button type="button" class="btn btn-soft btn-full" (click)="fileTC.click()">
          <ion-icon name="document-attach-outline"></ion-icon>
          Subir archivo
        </button>
        <input #fileTC type="file" (change)="onFileTC($event)" accept="image/*,application/pdf" hidden>

        <small class="tc__filename" *ngIf="tarjetaCirculacion">{{ tarjetaCirculacion.name }}</small>
      </label>
    </div>
  </div>

  <!-- Ficha rápida -->
  <div class="grid">
    <!-- Versión (con opciones desde CarsService y modo manual) -->
    <div class="campo">
      <label>Versión</label>

      <ng-container *ngIf="versionesDisponibles; else versionManual">
        <select [(ngModel)]="version" (ngModelChange)="onSeleccionVersion($event)">
          <option value="">Seleccione…</option>
          <option *ngFor="let v of versiones" [value]="v">{{ v }}</option>
        </select>
      </ng-container>

      <ng-template #versionManual>
        <input type="text" [(ngModel)]="version" (ngModelChange)="onSeleccionVersion($event)"
          placeholder="Ej. Advance CVT">
      </ng-template>
    </div>

    <!-- Estos campos manuales SOLO cuando NO hay versiones -->
    <div class="campo" *ngIf="!versionesDisponibles">
      <label>Tipo de vehículo</label>
      <select [(ngModel)]="tipoVehiculoLocal">
        <option value="">Seleccione…</option>
        <option>sedan</option>
        <option>suv</option>
        <option>pickup</option>
        <option>van</option>
        <option>hatchback</option>
        <option>otro</option>
      </select>
    </div>

    <div class="campo" *ngIf="!versionesDisponibles">
      <label>Transmisión</label>
      <select [(ngModel)]="transmision">
        <option value="">Seleccione…</option>
        <option>manual</option>
        <option>automática</option>
        <option>CVT</option>
      </select>
    </div>

    <div class="campo" *ngIf="!versionesDisponibles">
      <label>Combustible</label>
      <select [(ngModel)]="combustible">
        <option value="">Seleccione…</option>
        <option>gasolina</option>
        <option>diesel</option>
        <option>híbrido</option>
        <option>eléctrico</option>
      </select>
    </div>

    <!-- Color SIEMPRE visible -->
    <div class="campo">
      <label>Color</label>
      <select [(ngModel)]="color" (ngModelChange)="onColorChange($event)">
        <option value="">Seleccione…</option>
        <option *ngFor="let opcion of opcionesColores" [value]="opcion.label">
          {{ opcion.label }}
        </option>
      </select>
      <div *ngIf="color === 'Otro'" style="margin-top:6px;">
        <input type="text" [(ngModel)]="colorOtra" placeholder="Especifica el color" />
      </div>
    </div>

    <!-- Pasajeros SOLO cuando NO hay versiones (si hay, lo autocompleta la ficha) -->
    <div class="campo" *ngIf="!versionesDisponibles">
      <label>Pasajeros</label>
      <input type="number" min="1" [(ngModel)]="pasajeros" placeholder="Ej. 5">
    </div>

    <!-- Kilometraje SIEMPRE visible -->
    <div class="campo">
      <label>Kilometraje actual</label>
      <input type="number" min="0" [(ngModel)]="kilometrajeActual" placeholder="Ej. 52000">
    </div>
  </div>

  <!-- Ficha técnica (como en venta) -->
  <div class="grid" *ngIf="versionesDisponibles && especificacionesVersion">
    <div class="campo" style="grid-column: 1 / -1;">
      <div
        style="background:#fff;border-left:4px solid #fa2929;border-radius:10px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);max-width:600px;">
        <h4 style="margin:0 0 8px 0;">Ficha técnica</h4>
        <ul style="list-style:none;padding:0;margin:0;">
          <li *ngIf="especificacionesVersion.motor"><strong>Motor:</strong> {{ especificacionesVersion.motor }}</li>
          <li *ngIf="especificacionesVersion.potencia"><strong>Potencia:</strong> {{ especificacionesVersion.potencia }}
          </li>
          <li *ngIf="especificacionesVersion.cilindros"><strong>Cilindros:</strong> {{ especificacionesVersion.cilindros
            }}</li>
          <li *ngIf="especificacionesVersion.transmision"><strong>Transmisión:</strong> {{
            especificacionesVersion.transmision }}</li>
          <li *ngIf="especificacionesVersion.traccion"><strong>Tracción:</strong> {{ especificacionesVersion.traccion }}
          </li>
          <li *ngIf="especificacionesVersion.combustible"><strong>Combustible:</strong> {{
            especificacionesVersion.combustible }}</li>
          <li *ngIf="especificacionesVersion.pasajeros"><strong>Pasajeros:</strong> {{ especificacionesVersion.pasajeros
            }}</li>
          <li *ngIf="especificacionesVersion.puertas"><strong>Puertas:</strong> {{ especificacionesVersion.puertas }}
          </li>
          <li *ngIf="especificacionesVersion.rines"><strong>Rines:</strong> {{ especificacionesVersion.rines }}</li>
          <li *ngIf="especificacionesVersion.tipoVehiculo"><strong>Tipo de vehículo:</strong> {{
            especificacionesVersion.tipoVehiculo }}</li>
          <li *ngIf="especificacionesVersion.extra?.length">
            <strong>Extras:</strong>
            <ul style="margin:6px 0 0 16px;">
              <li *ngFor="let e of especificacionesVersion.extra">{{ e }}</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Precio -->
  <div class="grid">
    <div class="campo">
      <label>Precio por día ({{ moneda }}) <span class="req">*</span></label>
      <input type="number" min="500" [(ngModel)]="precioPorDia" placeholder="Ej. 900">
    </div>
    <div class="campo">
      <label>Moneda</label>
      <select [(ngModel)]="moneda">
        <option value="MXN">MXN</option>
        <option value="USD">USD</option>
      </select>
    </div>
  </div>

  <!-- Políticas / requisitos -->
  <div class="grid">
    <div class="campo">
      <label>Política combustible</label>
      <select [(ngModel)]="politicaCombustible">
        <option value="lleno-lleno">lleno-lleno</option>
        <option value="como-esta">como-esta</option>
      </select>
    </div>

    <div class="campo">
      <label>Política limpieza</label>
      <select [(ngModel)]="politicaLimpieza">
        <option value="normal">normal</option>
        <option value="estricta">estricta</option>
      </select>
    </div>

    <div class="campo">
      <label>Edad mínima</label>
      <input type="number" min="18" [(ngModel)]="requisitosConductor.edadMinima">
    </div>

    <div class="campo">
      <label>Antigüedad licencia (meses)</label>
      <input type="number" min="0" [(ngModel)]="requisitosConductor.antiguedadLicenciaMeses">
    </div>

    <div class="campo">
      <label>Conductor adicional</label>
      <select [(ngModel)]="requisitosConductor.permiteConductorAdicional">
        <option [ngValue]="false">No</option>
        <option [ngValue]="true">Sí</option>
      </select>
    </div>

    <div class="campo" *ngIf="requisitosConductor.permiteConductorAdicional">
      <label>Costo conductor adicional</label>
      <input type="number" min="0" [(ngModel)]="requisitosConductor.costoConductorAdicional">
    </div>
  </div>

  <!-- Entrega -->
  <div class="grid">
    <div class="campo">
      <label>Entrega gratis hasta (km)</label>
      <input type="number" min="0" [(ngModel)]="entrega.gratuitoHastaKm" (ngModelChange)="onGratisHastaChange()">
    </div>
  </div>

  <!-- Tarifas por distancia -->
  <div class="tarifas">
    <div class="tarifas__header">
      <label class="tarifas__title">Tarifas por distancia</label>
      <button type="button" class="btn btn-soft btn-sm" (click)="addTarifa()">+ Agregar tarifa</button>
    </div>
    <p class="hint">Agrega al menos una tarifa o especifica “Entrega gratis hasta (km)”.</p>

    <div class="tarifa-card" *ngFor="let t of entrega.tarifasPorDistancia; let i = index">
      <div class="tarifa-card__top">
        <h5 class="tarifa-card__title">Tarifa {{ i + 1 }}</h5>
        <button type="button" class="btn btn-danger btn-sm" (click)="removeTarifa(i)">
          <ion-icon name="trash-outline"></ion-icon> Quitar
        </button>
      </div>

      <div class="tarifa-card__grid">
        <!-- Desde -->
        <div class="campo">
          <label>Desde (km)</label>
          <input type="number" min="0" [(ngModel)]="t.desdeKm"
            [readonly]="i === 0 ? (+entrega.gratuitoHastaKm) > 0 : true" placeholder="0" />
          <small class="hint" *ngIf="i === 0 && (+entrega.gratuitoHastaKm) > 0">
            Fijado a {{ entrega.gratuitoHastaKm }} km (igual a “Entrega gratis hasta”).
          </small>
          <small class="hint" *ngIf="i > 0">
            Fijado a {{ entrega.tarifasPorDistancia[i-1].hastaKm || 0 }} km (fin del rango anterior).
          </small>
        </div>

        <!-- Hasta -->
        <div class="campo">
          <label>Hasta (km)</label>
          <input type="number" min="0" [(ngModel)]="t.hastaKm" (ngModelChange)="onTarifaHastaChange(i)"
            placeholder="10" />
        </div>

        <!-- Costo fijo -->
        <div class="campo">
          <label>Costo fijo</label>
          <input type="number" min="0" step="0.01" [(ngModel)]="t.costoFijo" placeholder="Ej. 200" />
        </div>

        <!-- Costo por km -->
        <div class="campo">
          <label>Costo por km</label>
          <input type="number" min="0" step="0.01" [(ngModel)]="t.costoPorKm" placeholder="Ej. 12" />
        </div>

        <!-- Nota -->
        <div class="campo full">
          <label>Nota (opcional)</label>
          <input type="text" [(ngModel)]="t.nota" placeholder="Ej. Zona centro" />
        </div>
      </div>
    </div>
  </div>

  <!-- Póliza (obligatoria) -->
  <div class="grid">
    <div class="campo">
      <label>Número de póliza <span class="req">*</span></label>
      <input type="text" [(ngModel)]="polizaPlataforma.numero" placeholder="Ej. ABC-123456">
    </div>
    <div class="campo">
      <label>Aseguradora <span class="req">*</span></label>
      <select [(ngModel)]="polizaPlataforma.aseguradora">
        <option value="">Seleccione…</option>
        <option>Uber</option>
        <option>DiDi</option>
        <option>inDrive</option>
        <option>Cabify</option>
        <option>Otro</option>
      </select>
    </div>
    <div class="campo" *ngIf="polizaPlataforma.aseguradora === 'Otro'">
      <label>¿Cuál aseguradora?</label>
      <input type="text" [(ngModel)]="polizaPlataforma.aseguradoraOtra" placeholder="Nombre de aseguradora">
    </div>
    <div class="campo">
      <label>Cobertura <span class="req">*</span></label>
      <select [(ngModel)]="polizaPlataforma.cobertura">
        <option value="">Seleccione…</option>
        <option>RC</option>
        <option>Amplia</option>
        <option>Amplia Plus</option>
      </select>
    </div>
    <div class="campo">
      <label>Vigencia desde <span class="req">*</span></label>
      <input type="date" [(ngModel)]="polizaPlataforma.vigenciaDesde">
    </div>
    <div class="campo">
      <label>Vigencia hasta <span class="req">*</span></label>
      <input type="date" [(ngModel)]="polizaPlataforma.vigenciaHasta">
    </div>
    <div class="campo">
      <label>URL de póliza (opcional)</label>
      <input type="url" [(ngModel)]="polizaPlataforma.urlPoliza" placeholder="https://...">
    </div>
  </div>
</section>
